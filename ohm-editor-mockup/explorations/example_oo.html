<html>
<head>
<script type="text/ohm-js">

O {

  Program
    = Stmts

  Stmts
    = Stmt* Exp?

  Stmt
    = class ident (extends ident)? (with NonemptyListOf<ident, ",">)? ";"  -- classDecl
    | def ident "." ident "(" ListOf<ident, ","> ")" MethodBody            -- methodDeclJava
    | def ident (ident ":" ident)+ MethodBody                              -- methodDeclKeyword
    | def ident binSelector ident MethodBody                               -- methodDeclBinary
    | def ident "(" ListOf<ident, ","> ")" MethodBody                      -- methodDeclCall
    | var ident "=" Exp ";"                                                -- varDecl
    | ident "=" Exp ";"                                                    -- varAssign
    | this "." ident "=" Exp ";"                                           -- instVarAssign
    | return Exp ";"                                                       -- return
    | Exp ";"                                                              -- exp

  MethodBody
    = "=" Exp ";"    -- exp
    | "{" Stmts "}"  -- stmt

  Exp
    = KWSendExp

  KWSendExp
    = EqExp (ident ":" EqExp)+  -- send
    | super (ident ":" EqExp)+  -- super
    | EqExp

  EqExp
    = RelExp ("==" | "!=") RelExp  -- eq
    | RelExp

  RelExp
    = AddExp ("<=" | "<" | ">=" | ">") AddExp  -- rel
    | AddExp

  AddExp
    = AddExp ("+" | "-") MulExp  -- add
    | MulExp

  MulExp
    = MulExp ("*" | "/" | "%") DotExp  -- mul
    | DotExp

  DotExp
    = DotExp "." ident "(" Actuals ")"  -- send
    | super "." ident "(" Actuals ")"   -- super
    | this "." ident  ~"("              -- instVarAccess
    | UnExp

  UnExp
    = "-" CallExp  -- neg
    | CallExp

  CallExp
    = CallExp "(" Actuals ")"  -- call
    | PriExp

  PriExp
    = "(" Exp ")"                  -- paren
    | "{" BlockArgNames Stmts "}"  -- block
    | new ident "(" Actuals ")"    -- new
    | string                       -- str
    | ident                        -- ident
    | number                       -- number
    | this                         -- this
    | trueK                        -- true
    | falseK                       -- false
    | nullK                        -- null

  Actuals
    = ListOf<Exp, ",">

  BlockArgNames
    = ListOf<ident, ","> "|"  -- some
    |                         -- none

  // Lexical rules

  ident  (an identifier)
    = ~keyword letter alnum*

  string  (a string literal)
    = "\"" (~"\"" ~"\n" any)* "\""

  number  (a number literal)
    = digit* "." digit+  -- fract
    | digit+             -- whole

  binSelector  (a binary selector)
    = "==" | "!=" | "<=" | "<" | ">=" | ">" | "+"  | "-"  | "*"  | "/" | "%" | "@"

  class = "class" ~alnum
  def = "def" ~alnum
  extends = "extends" ~alnum
  falseK = "false" ~alnum
  new = "new" ~alnum
  nullK = "null" ~alnum
  return = "return" ~alnum
  super = "super" ~alnum
  this = "this" ~alnum
  trueK = "true" ~alnum
  var = "var" ~alnum
  with = "with" ~alnum

  keyword
    = class | def | extends | falseK | new | nullK | return | super | this | trueK | var | with

  space
   += comment

  comment
    = "/*" (~"*/" any)* "*/"  -- multiLine
    | "//" (~"\n" any)*       -- singleLine

  tokens
    = (keyword | ident | number | comment | any)*

}

</script>
<style>
columns {
  display: flex;
  flex-direction:row;
  width: 700px;
}

column {
  display: block;
  height: 100%;
  min-width: 800px;
  padding-left: 10px;
}

svg {
  width: 100px;
  /*height: 100%;*/
}

.current.leaf {
  background: hsla(0, 0%, 0%, 0);
}

.current{
  background: hsla(0, 0%, 0%, 0.05);
}

.current {
  transition: filter 0.2s ease;
  -o-transition: -o-filter 0.2s ease;
  -moz-transition: filter 0.2s ease;
  -webkit-transition: -webkit-filter 0.2s ease;

  filter: saturate(40%);
  -o-filter: saturate(40%);
  -moz-filter: saturate(40%);
  -webkit-filter: saturate(40%);
}

.current:hover,
.active {
  filter: saturate(150%);
  -o-filter: saturate(150%);
  -moz-filter: saturate(150%);
  -webkit-filter: saturate(150%);
}

circle {
  transition: filter 0.2s ease;
  -o-transition: -o-filter 0.2s ease;
  -moz-transition: filter 0.2s ease;
  -webkit-transition: -webkit-filter 0.2s ease;

  filter: inherit;
  -o-filter: inherit;
  -moz-filter: inherit;
  -webkit-filter: inherit;
}


.current[result="success"]{
  color: green;
}

.current[result="error"]{
  color: red;
}

div#visualization {
  display: flex;
  flex-direction: row;
}
</style>
</head>

<body>
<columns>
<column>
  <pre>
    O {

      Program
        = Stmts

      Stmts
        = Stmt* Exp?

      Stmt
        = class ident (extends ident)? (with NonemptyListOf<ident, ",">)? ";"  -- classDecl
        | def ident "." ident "(" ListOf<ident, ","> ")" MethodBody            -- methodDeclJava
        | def ident (ident ":" ident)+ MethodBody                              -- methodDeclKeyword
        | def ident binSelector ident MethodBody                               -- methodDeclBinary
        | def ident "(" ListOf<ident, ","> ")" MethodBody                      -- methodDeclCall
        | var ident "=" Exp ";"                                                -- varDecl
        | ident "=" Exp ";"                                                    -- varAssign
        | this "." ident "=" Exp ";"                                           -- instVarAssign
        | return Exp ";"                                                       -- return
        | Exp ";"                                                              -- exp

      MethodBody
        = "=" Exp ";"    -- exp
        | "{" Stmts "}"  -- stmt

      Exp
        = KWSendExp

      KWSendExp
        = EqExp (ident ":" EqExp)+  -- send
        | super (ident ":" EqExp)+  -- super
        | EqExp

      EqExp
        = RelExp ("==" | "!=") RelExp  -- eq
        | RelExp

      RelExp
        = AddExp ("<=" | "<" | ">=" | ">") AddExp  -- rel
        | AddExp

      AddExp
        = AddExp ("+" | "-") MulExp  -- add
        | MulExp

      MulExp
        = MulExp ("*" | "/" | "%") DotExp  -- mul
        | DotExp

      DotExp
        = DotExp "." ident "(" Actuals ")"  -- send
        | super "." ident "(" Actuals ")"   -- super
        | this "." ident  ~"("              -- instVarAccess
        | UnExp

      UnExp
        = "-" CallExp  -- neg
        | CallExp

      CallExp
        = CallExp "(" Actuals ")"  -- call
        | PriExp

      PriExp
        = "(" Exp ")"                  -- paren
        | "{" BlockArgNames Stmts "}"  -- block
        | new ident "(" Actuals ")"    -- new
        | string                       -- str
        | ident                        -- ident
        | number                       -- number
        | this                         -- this
        | trueK                        -- true
        | falseK                       -- false
        | nullK                        -- null

      Actuals
        = ListOf<Exp, ",">

      BlockArgNames
        = ListOf<ident, ","> "|"  -- some
        |                         -- none

      // Lexical rules

      ident  (an identifier)
        = ~keyword letter alnum*

      string  (a string literal)
        = "\"" (~"\"" ~"\n" any)* "\""

      number  (a number literal)
        = digit* "." digit+  -- fract
        | digit+             -- whole

      binSelector  (a binary selector)
        = "==" | "!=" | "<=" | "<" | ">=" | ">" | "+"  | "-"  | "*"  | "/" | "%" | "@"

      class = "class" ~alnum
      def = "def" ~alnum
      extends = "extends" ~alnum
      falseK = "false" ~alnum
      new = "new" ~alnum
      nullK = "null" ~alnum
      return = "return" ~alnum
      super = "super" ~alnum
      this = "this" ~alnum
      trueK = "true" ~alnum
      var = "var" ~alnum
      with = "with" ~alnum

      keyword
        = class | def | extends | falseK | new | nullK | return | super | this | trueK | var | with

      space
       += comment

      comment
        = "/*" (~"*/" any)* "*/"  -- multiLine
        | "//" (~"\n" any)*       -- singleLine

      tokens
        = (keyword | ident | number | comment | any)*

    }
  </pre>
</column>

<column>
<div id="visualization">
  <pre id="example">
    class Point with x, y;

    def Point.init(x, y) {
      this.x = x;
      this.y = y;
    }

    def Point.toString() {
      return "Point(" + this.x + ", " + this.y + ")";
    }


    class ThreeDeePoint extends Point with z;

    def ThreeDeePoint.init(x, y, z) {
      super.init(x, y);
      this.z = z;
    }

    def ThreeDeePoint.toString() {
      return "ThreeDeePoint(" +
      this.x + ", " +
      this.y + ", " +
      this.z + ")";
    }
  </pre>
  <svg id="tree"></svg>
</div>
</column>
</columns>

<script src="../lib/ohm.js"></script>
<script src="reify.js"></script>
<script src="mapSemantics.js"></script>
<script src="classes.js"></script>
<script src="toAST.js"></script>
<script src="d3.min.js"></script>
<script src="tree_visualization.js"></script>
<script src="simplifyCST.js"></script>
<script>
'use strict';

document.addEventListener("DOMContentLoaded", function(event) {
  let grammar = ohm.grammarFromScriptElement();

  let semantics = grammar.semantics();

  registerReifyActions(semantics);
  registerToAST(semantics);
  registerMapSemantics(grammar, semantics);
  registerSimplifyAction(semantics);

  let exampleNode = document.querySelector('pre#example');
  let example = exampleNode.textContent;
  let match = grammar.match(example);

  let reified = reify(semantics, match);
  let DOM = reified[0],
      domToOhm = reified[1],
      ohmToDom = reified[2];

  exampleNode.textContent = "";
  exampleNode.appendChild(DOM);

  window.DOM2OHM = domToOhm;
  window.OHM2DOM = ohmToDom;

  let nodeToSimplified = new Map();
  let semmatch = semantics(match);
  let simplifiedCST = semmatch.simplifyCST(null, nodeToSimplified);

  let nodeToResults = mapSemantics(semantics, "toAST", match);

  for(let key of nodeToResults.keys()){
    if(! (key.constructor.name === "TerminalNode")){
      let domNode = ohmToDom.get(key);
      let result = nodeToResults.get(key);

      key.result = result;
      domNode.setAttribute("result", result instanceof Error? "error": "success");
    }
  }


  DOM.classList.add("current");
  nodeToSimplified.get(domToOhm.get(DOM)).current = true;

  //TODO: rework TreeViz to use simplifiedCST
  let treeVisualization = new TreeViz(
    document.querySelector("svg"),
    simplifiedCST,
    ohmToDom
  );

  //DONE:TODO: rework this to step through simplified tree
  Array.prototype.slice.call(document.querySelectorAll(".current")).forEach(function(node){
    let listener = (currentNode, event)=>{
      let currentSimplified = nodeToSimplified.get(domToOhm.get(currentNode));

      currentNode.removeEventListener("click", memobind1(listener, currentNode));
      if(currentNode.children.length > 0){
        currentNode.classList.remove("current");
        currentSimplified.current = false;

        Array.prototype.slice.call(nodeToSimplified.get(domToOhm.get(currentNode))._children).forEach((child)=>{
          let domChild = ohmToDom.get(child.cstNodes.slice(-1)[0]);

          domChild.addEventListener("click", memobind1(listener, domChild));
          domChild.classList.add("current");
          child.current = true;
        });
      } else {
        currentNode.classList.add("leaf");
      }
      treeVisualization.split(currentSimplified);
    };
    node.addEventListener("click", memobind1(listener, node));
  });
});

let memo = new Map();
function memobind1(fn, arg){
  if(memo.has(fn) && memo.get(fn).has(arg)){
    return memo.get(fn).get(arg);
  } else {
    let bound = fn.bind(null, arg);
    if( !memo.has(fn) ){
      memo.set(fn, new Map());
    }

    memo.get(fn).set(arg, bound);
    return bound;
  }

}

</script>
</body>
</html>
